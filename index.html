<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>時尚 iOS 風 計算機</title>
<style>
  :root{
    --bg1: #f7f8fb;
    --bg2: #eef2ff;
    --glass: rgba(255,255,255,0.55);
    --accent: linear-gradient(135deg,#7c5cff 0%,#4dd2ff 100%);
    --btn-dark: #1f1f23;
    --muted: #8b90a6;
    --size: 16px;
    --radius: 16px;
    --gap: 12px;
  }
  *{box-sizing:border-box;font-family: -apple-system, "SF Pro Text", "Helvetica Neue", "Segoe UI", Roboto, Arial, sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px}
  .app{
    width: 380px;
    max-width:94vw;
    border-radius:26px;
    padding:18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.35));
    backdrop-filter: blur(10px) saturate(120%);
    box-shadow: 0 10px 30px rgba(27,31,41,0.12), inset 0 1px 0 rgba(255,255,255,0.6);
  }

  /* header */
  .header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
  }
  .title{
    font-weight:600;color:var(--btn-dark);
  }
  .sub{
    font-size:12px;color:var(--muted);
  }

  /* display */
  .display{
    border-radius:16px;padding:14px 16px;margin-bottom:18px;
    background: linear-gradient(180deg, rgba(250,250,255,0.85), rgba(245,247,255,0.65));
    box-shadow: 0 6px 18px rgba(30,34,40,0.06);
  }
  .expression{
    font-size:14px;color:var(--muted);min-height:20px;word-break:break-all;
  }
  .result{
    font-size:32px;font-weight:700;color:var(--btn-dark);text-align:right;margin-top:6px;
  }

  /* keypad */
  .pad{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:12px;
  }
  .btn{
    border:0;padding:16px;border-radius:14px;font-size:18px;font-weight:600;
    box-shadow: 0 6px 14px rgba(24,28,35,0.06);
    cursor:pointer;user-select:none;
    transition: transform .06s ease, box-shadow .06s ease;
  }
  .btn:active{transform: translateY(2px); box-shadow: 0 3px 8px rgba(24,28,35,0.06);}
  .btn--secondary{
    background: linear-gradient(180deg,#ffffff,#f4f6ff);
    color: var(--btn-dark);
  }
  .btn--operator{
    background: linear-gradient(180deg,#f5f4ff,#efe8ff);
    color:#3b2b9a;
  }
  .btn--accent{
    background: var(--accent);
    color: white;
    box-shadow: 0 8px 20px rgba(95,72,255,0.18), 0 2px 0 rgba(255,255,255,0.12) inset;
  }
  .btn--wide{
    grid-column: span 2;
  }
  .btn--ghost{
    background: transparent;color:var(--muted);box-shadow:none;border:1px solid rgba(0,0,0,0.03);
  }

  /* small footer hint */
  .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
  @media (max-width:420px){
    .result{font-size:28px}
    .btn{padding:14px;font-size:16px}
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="計算機">
    <div class="header">
      <div>
        <div class="title">計算機</div>
        <div class="sub">時尚 iOS 風 • 保留算式</div>
      </div>
      <div class="sub" id="mode">基本</div>
    </div>

    <div class="display" id="display" aria-live="polite">
      <div class="expression" id="expression">0</div>
      <div class="result" id="result">0</div>
    </div>

    <div class="pad" id="pad">
      <button class="btn btn--secondary" data-action="ac">AC</button>
      <button class="btn btn--secondary" data-action="back">⌫</button>
      <button class="btn btn--secondary" data-value="(">(</button>
      <button class="btn btn--operator" data-value=")">)</button>

      <button class="btn btn--secondary" data-value="7">7</button>
      <button class="btn btn--secondary" data-value="8">8</button>
      <button class="btn btn--secondary" data-value="9">9</button>
      <button class="btn btn--operator" data-value="÷">÷</button>

      <button class="btn btn--secondary" data-value="4">4</button>
      <button class="btn btn--secondary" data-value="5">5</button>
      <button class="btn btn--secondary" data-value="6">6</button>
      <button class="btn btn--operator" data-value="×">×</button>

      <button class="btn btn--secondary" data-value="1">1</button>
      <button class="btn btn--secondary" data-value="2">2</button>
      <button class="btn btn--secondary" data-value="3">3</button>
      <button class="btn btn--operator" data-value="-">−</button>

      <button class="btn btn--secondary btn--wide" data-value="0">0</button>
      <button class="btn btn--secondary" data-value=".">.</button>
      <button class="btn btn--accent" data-value="=">=</button>
      <button class="btn btn--operator" data-value="+">+</button>

      <button class="btn btn--ghost" data-action="percent">%</button>
      <button class="btn btn--ghost" data-action="copy">複製</button>
      <button class="btn btn--ghost" style="grid-column: span 2;" data-action="clearEntry">CE</button>
    </div>

    <div class="hint">支援鍵盤輸入（數字、+-*/()、Enter 等）</div>
  </div>

<script>
(() => {
  const exprEl = document.getElementById('expression');
  const resEl = document.getElementById('result');
  const pad = document.getElementById('pad');

  let expression = '';    // user-visible expression using × ÷ −
  let lockedResult = null; // if user pressed =, store fixed result

  // helper: sanitize for eval (convert × ÷ − to * / -)
  function toEvalStr(expr){
    // replace unicode minus with hyphen
    let s = expr.replace(/[×]/g,'*').replace(/[÷]/g,'/').replace(/[−]/g,'-');
    // remove any invalid chars (allow digits, operators, dot, percent, parentheses and spaces)
    // percent handled separately
    s = s.replace(/[^0-9\+\-\*\/\.\%\(\)\s]/g,'');
    // handle percent: convert 'number%' -> '(number/100)'
    s = s.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
    return s;
  }

  function safeEval(expr){
    try {
      const ev = toEvalStr(expr);
      // basic safety: only allow digits, operators, parentheses, dot, slash, star and spaces
      if (!/^[0-9\+\-\*\/\.\(\)\s\/]*$/.test(ev.replace(/\(\d+(\.\d+)?\/100\)/g,''))){
        return NaN;
      }
      // eslint-disable-next-line no-new-func
      const fn = new Function('return (' + ev + ')');
      const val = fn();
      if (typeof val === 'number' && isFinite(val)) return val;
      return NaN;
    } catch (e){
      return NaN;
    }
  }

  function render(){
    exprEl.textContent = expression || '0';
    // live compute
    const val = safeEval(expression);
    resEl.textContent = isNaN(val) ? '—' : (Math.round((val + Number.EPSILON) * 1e12)/1e12).toString();
  }

  function pushChar(ch){
    // if previously locked by = and user presses number/paren/decimal, reset expression
    if (lockedResult !== null && /[0-9.(]/.test(ch)){
      expression = '';
      lockedResult = null;
    }
    // prevent multiple leading zeros like "00" in fresh state
    if (expression === '0' && /[0-9]/.test(ch)) {
      expression = ch;
    } else {
      expression += ch;
    }
    render();
  }

  function doBackspace(){
    if (lockedResult !== null){
      lockedResult = null;
    }
    expression = expression.slice(0, -1);
    render();
  }

  function doAC(){
    expression = '';
    lockedResult = null;
    render();
  }

  function doCE(){
    // clear last entry: remove trailing number / parentheses group
    expression = expression.replace(/[\d\.%]+$|[\(\)][\d\.\+\-\*\/%]*$|[^\d\.\%\)]*$/,'');
    render();
  }

  function doPercent(){
    // append percent sign if it makes sense
    if (expression === '') return;
    // if last char is number, add %
    if (/\d$/.test(expression)) expression += '%';
    render();
  }

  function doCopy(){
    const toCopy = expression || resEl.textContent || '0';
    navigator.clipboard?.writeText(toCopy).then(()=> {
      // small UI hint: temporarily change mode text
      const mode = document.getElementById('mode');
      const prev = mode.textContent;
      mode.textContent = '已複製';
      setTimeout(()=> mode.textContent = prev,800);
    }).catch(()=> alert('複製失敗'));
  }

  function doEqual(){
    const val = safeEval(expression);
    if (isNaN(val)){
      resEl.textContent = '錯誤';
      lockedResult = null;
    } else {
      const displayVal = (Math.round((val + Number.EPSILON) * 1e12)/1e12).toString();
      resEl.textContent = displayVal;
      expression = displayVal; // let expression become the result for chaining
      lockedResult = displayVal;
    }
    render();
  }

  pad.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const value = btn.dataset.value;
    const action = btn.dataset.action;
    if (action){
      if (action === 'ac') doAC();
      else if (action === 'back') doBackspace();
      else if (action === 'percent') doPercent();
      else if (action === 'copy') doCopy();
      else if (action === 'clearEntry') doCE();
      return;
    }
    if (value){
      if (value === '=') { doEqual(); return; }
      // allowed inputs: digits, ., operators, parentheses
      const permitted = /^[0-9\.\+\-×÷\(\)]$/;
      if (permitted.test(value)) pushChar(value);
    }
  });

  // keyboard support
  window.addEventListener('keydown', (e) => {
    if (e.metaKey || e.ctrlKey) {
      if (e.key.toLowerCase() === 'c') { doCopy(); e.preventDefault(); }
      return;
    }
    if (e.key === 'Enter' || e.key === '=') { doEqual(); e.preventDefault(); return; }
    if (e.key === 'Backspace') { doBackspace(); e.preventDefault(); return; }
    if (e.key === 'Escape') { doAC(); e.preventDefault(); return; }
    if (e.key === '%') { doPercent(); e.preventDefault(); return; }
    // map * / - + to × ÷ − + for visual
    if (/[0-9]/.test(e.key)) { pushChar(e.key); e.preventDefault(); return; }
    if (e.key === '.') { pushChar('.'); e.preventDefault(); return; }
    if (e.key === '*') { pushChar('×'); e.preventDefault(); return; }
    if (e.key === '/') { pushChar('÷'); e.preventDefault(); return; }
    if (e.key === '-') { pushChar('−'); e.preventDefault(); return; }
    if (e.key === '+') { pushChar('+'); e.preventDefault(); return; }
    if (e.key === '(') { pushChar('('); e.preventDefault(); return; }
    if (e.key === ')') { pushChar(')'); e.preventDefault(); return; }
  });

  // init
  doAC();
})();
</script>
</body>
</html>