<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>iOS Style Calculator</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
    body{
        margin:0;
        background:#000;
        display:flex;
        justify-content:center;
        align-items:center;
        height:100vh;
        overflow:hidden;
        touch-action:manipulation;
        font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue";
    }

    .calculator{
        width: min(95vw, 500px);
        height: min(90vh, 800px);
        display:flex;
        flex-direction:column;
        justify-content:space-between;
    }

    .display{
        color:white;
        text-align:right;
        padding:20px;
        font-size:3rem;
        height:120px;
        overflow:hidden;
        white-space:pre-wrap;
        display:flex;
        flex-direction:column;
        justify-content:flex-end;
    }

    .formula{
        color:#888;
        font-size:1.2rem;
        margin-bottom:5px;
        white-space:pre-wrap;
    }

    .current-number{
        color:white;
        font-size:2.5rem;
        line-height:1.2;
    }

    .buttons{
        display:grid;
        gap:10px;
        width:100%;
        height:100%;
    }

    @media (orientation:portrait){
        .buttons{
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
        }
    }

    @media (orientation:landscape){
        .calculator{
            width: min(90vw, 650px);
            height: min(95vh, 450px);
        }
        .buttons{
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }
    }

    button{
        border:none;
        border-radius:18px;
        font-size:2rem;
        color:white;
        background:#333;
        transition:transform 0.05s;
        touch-action:manipulation;
    }

    button:active{
        transform:scale(0.92);
    }

    .orange{ background:#ff9f0a; }
    .gray{ background:#a5a5a5; color:black; }
</style>
</head>

<body>

<div class="calculator">
    <div class="display">
        <div class="formula" id="formula"></div>
        <div class="current-number" id="currentNumber">0</div>
    </div>

    <div class="buttons">
        <button class="gray">AC</button>
        <button class="gray">+/-</button>
        <button class="gray">%</button>
        <button class="orange">÷</button>

        <button>7</button>
        <button>8</button>
        <button>9</button>
        <button class="orange">×</button>

        <button>4</button>
        <button>5</button>
        <button>6</button>
        <button class="orange">−</button>

        <button>1</button>
        <button>2</button>
        <button>3</button>
        <button class="orange">+</button>

        <button style="grid-column: span 2;">0</button>
        <button>.</button>
        <button class="orange">=</button>
    </div>
</div>

<script>
const formula = document.getElementById("formula");
const currentNumber = document.getElementById("currentNumber");

let current = "0";
let expr = "";
let history = [];
const operatorMap = {"+":"加","−":"減","×":"乘","÷":"除"};

// 數字轉中文
function numberToChinese(numStr){
    const digit = ['零','一','二','三','四','五','六','七','八','九'];
    const unit = ['','十','百','千','萬','十萬','百萬','千萬','億'];
    if(numStr==="0") return "零";
    if(isNaN(numStr)) return numStr;

    let [intPart, decPart] = numStr.split(".");
    let result = "";
    let len = intPart.length;
    for(let i=0;i<len;i++){
        let n = parseInt(intPart[i]);
        let u = unit[len-i-1];
        if(n!==0){
            result += digit[n]+u;
        }else{
            if(!result.endsWith("零") && i!==len-1){
                result += "零";
            }
        }
    }
    result = result.replace(/零+$/,"");
    result = result.replace(/^一十/,"十");

    if(decPart){
        result += "點";
        for(let ch of decPart){
            result += digit[parseInt(ch)];
        }
    }
    return result;
}

// 算式轉中文（保留運算符中文）
function exprToChinese(expression){
    return expression.replace(/\d+(\.\d+)?/g, num=>numberToChinese(num))
                     .replace(/[+\-×÷]/g, op=>operatorMap[op]);
}

document.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        const v = btn.innerText;

        // 運算符中文語音
        if(operatorMap[v]){
            speak(operatorMap[v]);
        } else if(v === "="){
            // 計算後唸完整算式
        } else {
            speak(v); // 數字或其他
        }

        // 按鍵邏輯
        if(!isNaN(v)){
            current = current==="0"?v:current+v;
        } else if(["+","−","×","÷"].includes(v)){
            expr += current + v;
            current="0";
        } else if(v==="AC"){
            current="0"; expr=""; history=[];
        } else if(v==="."){
            if(!current.includes(".")) current += ".";
        } else if(v==="+/-"){
            current=(parseFloat(current)*-1).toString();
        } else if(v==="%"){
            current=(parseFloat(current)/100).toString();
        } else if(v==="="){
            expr += current;
            let resultStr;
            try{
                current = eval(expr.replace(/×/g,"*").replace(/÷/g,"/").replace(/−/g,"-")).toString();
                resultStr = current;
            }catch(e){
                current="Error";
                resultStr="錯誤";
            }

            // 歷史顯示
            history.push(expr + "=" + current);
            if(history.length>2) history.shift();

            // 唸中文算式，例如「五減二等於三」
            if(current!=="Error"){
                let chineseExpr = exprToChinese(expr) + "等於" + numberToChinese(resultStr);
                speak(chineseExpr);
            }

            expr="";
        }

        formula.innerText = history.join("\n") + (expr? "\n"+expr : "");
        currentNumber.innerText = current;
    });
});

// 中文語音
function speak(text){
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang="zh-TW";
    msg.rate=1;
    msg.pitch=1;
    msg.volume=1;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
}

// PWA
if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>