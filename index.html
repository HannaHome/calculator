<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS 風格大按鈕計算機</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Tailwind CSS 配置，使用 Inter 字體 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // iOS-like Dark Theme Colors
                        'app-bg': '#000000',      // 應用程式背景：純黑
                        'display-text': '#ffffff',// 顯示文字：白色
                        'num-button': '#333333',  // 數字按鈕：深灰
                        'op-button': '#ff9500',   // 運算符按鈕：亮橘色
                        'ctrl-button': '#a6a6a6', // 控制按鈕：淺灰 (C)
                        'ctrl-text': '#000000',   // 控制按鈕文字：黑色
                    }
                }
            }
        }
    </script>
    <style>
        /* 確保整個應用程式佔滿螢幕並使用黑色背景 */
        body {
            background-color: var(--tw-colors-app-bg);
        }

        /* 計算機容器，在寬螢幕上保持最大寬度，在小螢幕上佔滿 */
        .calculator-container {
            width: 100%;
            max-width: 450px; /* 限制最大寬度以保持舒適的尺寸 */
            min-height: 80vh; /* 最小高度，讓它看起來大 */
        }

        /* 顯示區域的特殊佈局，確保內容靠右下方對齊 */
        #display-area {
            min-height: 120px;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            word-break: break-all;
        }
        
        /* 算式保留區的字體縮放，確保長算式能顯示 */
        #historyDisplay {
            font-size: 1.5rem; /* 較小的字體 */
            line-height: 1.2;
            color: var(--tw-colors-gray-400); /* 較暗的顏色 */
            max-width: 100%;
            white-space: nowrap;
            overflow-x: hidden;
            text-overflow: ellipsis;
        }

        /* 結果顯示區的字體縮放，確保大數字能顯示 */
        #resultDisplay {
            font-weight: 300; /* 輕盈的字體 */
            line-height: 1;
            /* 調整字體大小，使其能適應螢幕寬度 */
            font-size: clamp(3rem, 15vw, 6rem); 
            max-width: 100%;
            white-space: nowrap;
            overflow-x: hidden;
            text-overflow: clip;
        }

        /* 通用按鈕樣式，使用圓形或圓角，並確保尺寸大 */
        .calc-button {
            /* 讓按鈕高度等於寬度，保持正方形 */
            width: 100%;
            padding-bottom: 100%; /* 100% of the parent width */
            position: relative;
            border-radius: 9999px; /* 圓形按鈕 */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: 400;
            transition: background-color 0.1s;
            touch-action: manipulation; /* 增強移動設備觸控響應 */
            user-select: none;
        }

        /* 讓按鈕內容居中 */
        .calc-button > span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 按鈕按下時的效果 */
        .calc-button:active {
            filter: brightness(120%);
        }

        /* 零按鈕的樣式：寬度是兩個按鈕加間距 */
        .zero-button {
            /* 調整為兩倍寬度 - 這是 Tailwind grid 的處理方式 */
            grid-column: span 2;
            padding-bottom: 50%; /* 保持高度與單個按鈕相同 */
            border-radius: 9999px;
            /* 調整內容對齊，使其靠左 */
            justify-content: flex-start; 
            padding-left: 30px; 
        }

        .zero-button > span {
            left: 20%; /* 讓 0 靠左對齊 */
            transform: translate(0, -50%);
        }

        /* 運算符按鈕激活狀態，模擬 iOS 的亮色背景 */
        .op-active {
            background-color: white !important;
            color: var(--tw-colors-op-button) !important;
        }
        
    </style>
</head>
<body class="bg-app-bg font-sans flex items-end justify-center min-h-screen p-4 pb-12 sm:pb-4">

    <!-- 計算機主容器，使用 flex-col-reverse 使按鈕在下方 -->
    <div class="calculator-container flex flex-col justify-end bg-app-bg">
        
        <!-- 顯示區域 (Display Area) -->
        <div id="display-area">
            <!-- 算式保留區 (History/Expression) -->
            <div id="historyDisplay">0</div>
            
            <!-- 結果顯示區 (Current Result/Input) -->
            <div id="resultDisplay" class="text-display-text">0</div>
        </div>

        <!-- 按鈕區域 (Button Grid) -->
        <div class="grid grid-cols-4 gap-3">
            
            <!-- 第一行：控制按鈕 (C) -->
            <button data-value="C" class="calc-button bg-ctrl-button hover:bg-gray-400 text-ctrl-text">
                <span id="clearButtonLabel">C</span>
            </button>
            <button data-value="+/-" class="calc-button bg-ctrl-button hover:bg-gray-400 text-ctrl-text">
                <span>±</span>
            </button>
            <button data-value="%" class="calc-button bg-ctrl-button hover:bg-gray-400 text-ctrl-text">
                <span>%</span>
            </button>
            <button data-value="/" class="calc-button bg-op-button hover:bg-orange-400 text-display-text" data-type="operator">
                <span>÷</span>
            </button>
            
            <!-- 第二行：數字與乘法 -->
            <button data-value="7" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>7</span></button>
            <button data-value="8" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>8</span></button>
            <button data-value="9" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>9</span></button>
            <button data-value="*" class="calc-button bg-op-button hover:bg-orange-400 text-display-text" data-type="operator">
                <span>×</span>
            </button>

            <!-- 第三行：數字與減法 -->
            <button data-value="4" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>4</span></button>
            <button data-value="5" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>5</span></button>
            <button data-value="6" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>6</span></button>
            <button data-value="-" class="calc-button bg-op-button hover:bg-orange-400 text-display-text" data-type="operator">
                <span>−</span>
            </button>

            <!-- 第四行：數字與加法 -->
            <button data-value="1" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>1</span></button>
            <button data-value="2" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>2</span></button>
            <button data-value="3" class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>3</span></button>
            <button data-value="+" class="calc-button bg-op-button hover:bg-orange-400 text-display-text" data-type="operator">
                <span>+</span>
            </button>

            <!-- 第五行：0、小數點與等於 -->
            <button data-value="0" class="calc-button zero-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>0</span></button>
            <button data-value="." class="calc-button bg-num-button hover:bg-gray-600 text-display-text" data-type="number"><span>.</span></button>
            <button data-value="=" class="calc-button bg-op-button hover:bg-orange-400 text-display-text" data-type="equals">
                <span>=</span>
            </button>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        // 獲取 DOM 元素
        const historyDisplay = document.getElementById('historyDisplay');
        const resultDisplay = document.getElementById('resultDisplay');
        const buttons = document.querySelectorAll('.calc-button');
        const clearButtonLabel = document.getElementById('clearButtonLabel');

        // 計算機狀態
        let currentExpression = ''; // 儲存完整的運算式 (例如: 10+5*2)
        let lastResult = null; // 儲存上次計算的結果
        let isResultDisplayed = false; // 標記是否剛顯示完結果 (按下了=)
        let lastOperator = null; // 儲存上一個運算符按鈕，用於重覆運算
        let awaitingSecondOperand = false; // 標記是否剛輸入運算符

        // 函式：更新 AC/C 按鈕標籤
        function updateClearButtonLabel() {
            clearButtonLabel.textContent = currentExpression === '' && lastResult === null ? 'AC' : 'C';
        }

        // 函式：更新顯示區的內容
        function updateDisplay() {
            // 更新算式保留區，如果為空則顯示 '0'
            historyDisplay.textContent = currentExpression || '0';
            
            // 嘗試從當前表達式中提取正在輸入的數字
            const parts = currentExpression.split(/([+\-*/])/).filter(p => p.trim() !== '');
            let currentNumber = '0';

            if (isResultDisplayed && lastResult !== null) {
                // 如果是結果顯示狀態，則顯示結果
                currentNumber = lastResult.toString();
            } else if (parts.length > 0) {
                const lastPart = parts[parts.length - 1];
                
                // 如果最後一個部分是數字
                if (!isNaN(parseFloat(lastPart)) || lastPart === '.') {
                    currentNumber = lastPart;
                } else if (parts.length > 1 && !isNaN(parseFloat(parts[parts.length - 2]))) {
                    // 如果最後一個部分是運算符，則顯示前一個數字
                    currentNumber = parts[parts.length - 2];
                }
            }
            
            resultDisplay.textContent = currentNumber;
            updateClearButtonLabel();
        }

        // 函式：清除所有狀態 (AC)
        function clearAll() {
            currentExpression = '';
            lastResult = null;
            isResultDisplayed = false;
            lastOperator = null;
            awaitingSecondOperand = false;
            updateDisplay();
            deactivateOperatorButtons();
        }

        // 函式：清除當前輸入 (C)
        function clearCurrentInput() {
            if (currentExpression === '' && lastResult === null) {
                // 如果是 AC 狀態，則完全清除
                clearAll();
                return;
            }

            // 找到運算式中的最後一個數字或操作數
            const match = currentExpression.match(/([+\-*/])(\d+\.?\d*)$/);
            
            if (match) {
                // 如果找到了操作符和數字，移除最後一個數字
                currentExpression = currentExpression.substring(0, currentExpression.length - match[2].length);
            } else {
                 // 如果只是一個數字，清空運算式
                currentExpression = '';
            }
            
            isResultDisplayed = false;
            updateDisplay();
        }

        // 函式：處理數字和小數點輸入
        function handleNumber(value) {
            deactivateOperatorButtons();

            if (isResultDisplayed) {
                // 剛按下等於後輸入數字，開始新的運算式
                currentExpression = '';
                lastResult = null;
                isResultDisplayed = false;
                awaitingSecondOperand = false;
            }

            // 確保運算式不是空的，以便處理數字
            if (currentExpression === '') {
                 if (value === '.') {
                    currentExpression = '0.';
                } else {
                    currentExpression = value;
                }
            } else {
                 // 檢查運算式末尾是否是運算符
                const lastChar = currentExpression.slice(-1);
                const isOperator = '+-*/'.includes(lastChar);

                if (isOperator) {
                    if (value === '.') {
                        // 運算符後輸入小數點，自動補零
                        currentExpression += '0.';
                    } else {
                        currentExpression += value;
                    }
                } else {
                    // 檢查當前數字是否已包含小數點
                    const parts = currentExpression.split(/([+\-*/])/).filter(p => p.trim() !== '');
                    const currentNumber = parts[parts.length - 1];
                    
                    if (value === '.') {
                        if (!currentNumber.includes('.')) {
                             currentExpression += value;
                        }
                    } else if (currentNumber === '0' && currentNumber.length === 1 && value !== '0') {
                        // 如果當前是單獨的 0，用新數字替換它
                        currentExpression = currentExpression.slice(0, -1) + value;
                    }
                     else {
                         currentExpression += value;
                     }
                }
            }
            
            updateDisplay();
        }

        // 函式：處理運算符輸入
        function handleOperator(value, targetButton) {
            if (currentExpression === '' && lastResult !== null) {
                // 如果有上次結果，以結果開始新的運算式
                currentExpression = lastResult.toString();
                lastResult = null;
                isResultDisplayed = false;
            }

            if (currentExpression === '') {
                // 運算式為空時忽略運算符
                return;
            }

            // 移除當前所有的激活狀態
            deactivateOperatorButtons();
            
            // 激活當前運算符按鈕
            targetButton.classList.add('op-active');
            
            // 檢查運算式末尾是否已經是運算符
            const lastChar = currentExpression.slice(-1);
            if ('+-*/'.includes(lastChar)) {
                // 如果是運算符，則替換它
                currentExpression = currentExpression.slice(0, -1) + value;
            } else {
                // 否則，添加新的運算符
                currentExpression += value;
            }
            
            lastOperator = value;
            awaitingSecondOperand = true;
            updateDisplay();
        }

        // 函式：處理等於按鈕
        function handleEquals() {
            deactivateOperatorButtons();

            if (currentExpression === '' && lastResult === null) {
                return;
            }
            
            // 確保運算式末尾不是運算符
            const lastChar = currentExpression.slice(-1);
            if ('+-*/'.includes(lastChar)) {
                currentExpression = currentExpression.slice(0, -1);
            }

            try {
                // 為了安全性，我們替換乘法符號 * 和除法符號 /，然後使用 Function 構造函數來計算
                const expressionToEvaluate = currentExpression.replace(/×/g, '*').replace(/÷/g, '/');
                
                // 執行計算
                let result = new Function('return ' + expressionToEvaluate)();
                
                // 處理無限大或 NaN
                if (!isFinite(result)) {
                    throw new Error("除數為零或結果過大");
                }
                
                // 限制小數位數以避免浮點數精度問題
                if (result.toString().includes('.') && result.toString().split('.')[1].length > 10) {
                     result = parseFloat(result.toFixed(10));
                }

                lastResult = result;
                
                // 顯示結果
                historyDisplay.textContent = currentExpression + ' =';
                resultDisplay.textContent = result.toString();

                // 重置狀態
                currentExpression = result.toString(); 
                isResultDisplayed = true;
                awaitingSecondOperand = false;

            } catch (error) {
                console.error("計算錯誤:", error);
                resultDisplay.textContent = "錯誤";
                historyDisplay.textContent = currentExpression;
                // 出錯後等待清除
                currentExpression = '';
                lastResult = null;
                isResultDisplayed = false;
            }
            updateClearButtonLabel();
        }

        // 函式：處理 +/- 按鈕 (正負號)
        function handleToggleSign() {
            let parts = currentExpression.split(/([+\-*/])/).filter(p => p.trim() !== '');
            
            if (parts.length === 0) {
                 if (lastResult !== null) {
                    lastResult *= -1;
                    currentExpression = lastResult.toString();
                    isResultDisplayed = true;
                 }
                // 如果兩者皆空，忽略
                updateDisplay();
                return;
            }

            let lastPart = parts[parts.length - 1];
            
            if ('+-*/'.includes(lastPart)) {
                // 如果最後是運算符，忽略
                return;
            }
            
            // 移除當前運算式中的最後一個數字
            let newExpression = currentExpression.substring(0, currentExpression.length - lastPart.length);

            // 轉換正負號
            let numericValue = parseFloat(lastPart);
            if (!isNaN(numericValue)) {
                let toggledValue = (-numericValue).toString();
                newExpression += toggledValue;
                currentExpression = newExpression;
                isResultDisplayed = false;
            }
            
            updateDisplay();
        }

        // 函式：處理 % 按鈕 (百分比)
        function handlePercentage() {
            let parts = currentExpression.split(/([+\-*/])/).filter(p => p.trim() !== '');
            
            if (parts.length === 0) {
                 if (lastResult !== null) {
                    lastResult /= 100;
                    currentExpression = lastResult.toString();
                    isResultDisplayed = true;
                 }
                updateDisplay();
                return;
            }

            let lastPart = parts[parts.length - 1];
            
            if ('+-*/'.includes(lastPart)) {
                return;
            }
            
            let newExpression = currentExpression.substring(0, currentExpression.length - lastPart.length);
            let numericValue = parseFloat(lastPart);

            if (!isNaN(numericValue)) {
                let percentageValue = (numericValue / 100).toString();
                newExpression += percentageValue;
                currentExpression = newExpression;
                isResultDisplayed = false;
            }
            
            updateDisplay();
        }

        // 函式：移除所有運算符按鈕的激活狀態
        function deactivateOperatorButtons() {
            document.querySelectorAll('[data-type="operator"]').forEach(btn => {
                btn.classList.remove('op-active');
            });
        }


        // --- 事件監聽器設定 ---
        buttons.forEach(button => {
            button.addEventListener('click', (e) => {
                // 找到實際帶有 data-value 的按鈕元素
                const targetButton = e.currentTarget;
                const value = targetButton.getAttribute('data-value');
                const type = targetButton.getAttribute('data-type');
                
                switch (value) {
                    case 'C':
                        // 檢查是 C 還是 AC
                        if (currentExpression === '' && lastResult === null) {
                             clearAll();
                        } else {
                             clearCurrentInput();
                        }
                        break;
                    case '+/-':
                        handleToggleSign();
                        break;
                    case '%':
                        handlePercentage();
                        break;
                    case '=':
                        handleEquals();
                        break;
                    case '+':
                    case '-':
                    case '*':
                    case '/':
                        handleOperator(value, targetButton);
                        break;
                    case '.':
                    case '0':
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                    case '7':
                    case '8':
                    case '9':
                        handleNumber(value);
                        break;
                }
            });
        });

        // 初始化顯示
        window.onload = clearAll;
    </script>
</body>
</html>


